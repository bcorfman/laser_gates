# This workflow will install Python dependencies and build executables with Nuitka
# It builds on Linux and Windows, stores each build as an artifact, creates a Release,
# then uploads each artifact to that Release with a per-asset label.
name: Build Application

on:
  push:
    tags:
      - "v[0-9]+.*"

permissions:
  contents: write

env:
  GITHUB_TOKEN: ${{ github.token }}
  APP_NAME: "lasergates"

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux
            python-version: "3.11"
          - os: windows-latest
            platform: windows
            python-version: "3.11"

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            **/requirements*.txt

      - uses: seanmiddleditch/gha-setup-vsdevenv@master
        if: matrix.os == 'windows-latest'

      - name: Set env repo name
        run: echo "REPOSITORY_NAME=${GITHUB_REPOSITORY#*/}" >> $GITHUB_ENV
        shell: bash

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Build Executable with Nuitka (Ubuntu)
        if: matrix.os == 'ubuntu-22.04'
        uses: Nuitka/Nuitka-Action@main
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        with:
          nuitka-version: main
          script-name: game.py
          mode: onefile
          output-file: lasergates
          static-libpython: "yes"
          nofollow-import-to: "*tk*,multiprocessing,gi"
          include-package: actions,laser_gates
          disable-plugins: tk-inter,dill-compat,eventlet,gevent,pyqt5,pyqt6,pyside2,pyside6,delvewheel,pywebview,matplotlib,spacy,enum-compat,pbr-compat,gevent,pmw-freezer,transformers,upx,kivy,options-nanny,multiprocessing,gi
          include-data-dir: res=res
          include-module: unicodedata

      - name: Build Executable with Nuitka (Windows)
        if: matrix.os == 'windows-latest'
        uses: Nuitka/Nuitka-Action@main
        env:
          PYTHONPATH: ${{ github.workspace }}/src
        with:
          nuitka-version: main
          script-name: game.py
          mode: onefile
          output-file: lasergates
          nofollow-import-to: "*tk*,multiprocessing,gi"
          include-package: actions,laser_gates
          disable-plugins: tk-inter,dill-compat,eventlet,gevent,pyqt5,pyqt6,pyside2,pyside6,delvewheel,pywebview,matplotlib,spacy,enum-compat,pbr-compat,gevent,pmw-freezer,transformers,upx,kivy,options-nanny,multiprocessing,gi
          include-data-dir: res=res
          include-module: unicodedata
          windows-console-mode: force

      - name: Locate and rename executable (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          set -euo pipefail
          echo "Searching for built Linux binary..."
          # List to help debugging when paths change
          ls -laR . | head -n 500 || true
          BIN=$(find . -maxdepth 4 -type f -name 'lasergates*' -perm -u+x | head -n1 || true)
          if [ -z "${BIN}" ]; then
            echo "ERROR: No Linux binary found after build"
            exit 1
          fi
          echo "Found: ${BIN}"
          mkdir -p build_output
          cp "${BIN}" build_output/laser_gates.bin
          chmod +x build_output/laser_gates.bin
          echo "Executable ready: build_output/laser_gates.bin"
        shell: bash

      - name: Locate and rename executable (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          Write-Host "Searching for built Windows binary..."
          Get-ChildItem -Recurse -File -Filter 'lasergates*.exe' | Select-Object -First 1 | ForEach-Object {
            Write-Host ("Found: " + $_.FullName)
            New-Item -ItemType Directory -Force -Path build_output | Out-Null
            Copy-Item $_.FullName "build_output\laser_gates.exe"
            Write-Host "Executable ready: build_output\laser_gates.exe"
          }
          if (!(Test-Path build_output\laser_gates.exe)) {
            Write-Error "ERROR: No Windows binary found after build"
            exit 1
          }
        shell: pwsh

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}
          path: build_output/laser_gates.*

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download All Build Artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloads

      - name: Create release (if missing) and upload artifacts to tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${{ github.ref_name }}"
          echo "Target release tag: $TAG"
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists; will upload assets with --clobber"
          else
            gh release create "$TAG" \
              --title "$TAG" \
              --notes "Automated build for $TAG"
          fi
          # Upload the executables directly (no zip files)
          gh release upload "$TAG" downloads/linux/laser_gates.bin --clobber
          gh release upload "$TAG" downloads/windows/laser_gates.exe --clobber